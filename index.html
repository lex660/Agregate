<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Исламская Рассрочка - Калькулятор</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" >
      (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
      (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

      const ymCounterId = "104202450"; 
      ym(ymCounterId, "init", {
          clickmap:true,
          trackLinks:true,
          accurateTrackBounce:true
      });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/104202450" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    
    <style>
        :root {
            --primary-color: #10B981;
            --primary-hover-color: #059669;
            --background-color: #F9FAFB;
            --card-background-color: #FFFFFF;
            --text-color: #1F2937;
            --text-light-color: #6B7280;
            --border-color: #E5E7EB;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        html { scroll-behavior: smooth; }
        body { font-family: 'Manrope', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 0; line-height: 1.6; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 2rem; box-sizing: border-box; }
        .header-section { text-align: center; margin-bottom: 2rem; }
        .header-section h1 { font-size: 2.25rem; margin: 0 0 0.5rem 0; }
        .header-section p { font-size: 1.125rem; color: var(--text-light-color); max-width: 650px; margin: 0 auto; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 2rem; align-items: flex-start; }
        .card { background-color: var(--card-background-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; }
        .card h2 { margin-top: 0; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 700; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .calculate-btn, .apply-btn, .submit-btn { width: 100%; padding: 1rem; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.125rem; font-weight: 700; cursor: pointer; transition: background-color 0.3s ease; text-align: center; text-decoration: none; display: inline-block; }
        .calculate-btn:hover, .apply-btn:hover, .submit-btn:hover { background-color: var(--primary-hover-color); }
        .apply-btn { font-size: 0.9rem; padding: 0.75rem 1rem; }
        #results-container .placeholder { text-align: center; color: var(--text-light-color); padding: 3rem 1rem; border: 2px dashed var(--border-color); border-radius: var(--border-radius); }
        .table-wrapper { overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .results-table th, .results-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .results-table .bank-name-cell { font-weight: 700; }
        .results-table .bank-note { display: block; font-size: 0.8rem; color: var(--text-light-color); font-weight: 400; }
        .results-table th { font-weight: 700; color: var(--text-light-color); font-size: 0.8rem; text-transform: uppercase; }
        .results-table tr:last-child td { border-bottom: none; }
        .disclaimer { font-size: 0.875rem; color: var(--text-light-color); text-align: center; margin-top: 1.5rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--card-background-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 90%; max-width: 500px; position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; font-weight: bold; color: var(--text-light-color); cursor: pointer; border: none; background: none; }
        footer { text-align: center; padding: 2rem; margin-top: 2rem; color: var(--text-light-color); font-size: 0.9rem; }
        .hidden { display: none; }
        @media (max-width: 820px) { .main-layout { grid-template-columns: 1fr; } .container { padding: 1rem; } }
        @media (max-width: 600px) {
            .header-section h1 { font-size: 1.8rem; }
            .header-section p { font-size: 1rem; }
            .card { padding: 1.5rem; }
            .table-wrapper { overflow-x: hidden; }
            .results-table { min-width: unset; border: 0; }
            .results-table thead { border: none; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; width: 1px; }
            .results-table tr { display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1rem; box-shadow: none; }
            .results-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); padding: 0.75rem 0.25rem; }
            .results-table td:last-child { border-bottom: 0; display: block; padding-top: 1rem; }
            .results-table td::before { content: attr(data-label); font-weight: 700; text-align: left; padding-right: 1rem; }
            .results-table td.bank-name-cell { display: block; font-size: 1.25rem; text-align: center; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem; }
            .results-table td.bank-name-cell::before { display: none; }
            .results-table .apply-btn { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="header-section">
            <h1>Калькулятор исламской рассрочки</h1>
            <p>Сравните условия от разных банков и выберите лучшее предложение. Сервис работает в тестовом режиме. </p>
        </header>

        <main class="main-layout">
            <section id="calculator-section" class="card">
                <h2>Параметры расчета</h2>
                <form id="calculator-form" aria-label="Форма калькулятора рассрочки">
                    <div class="form-group">
                        <label for="region">Регион</label>
                        <select id="region" name="region" required>
                            <option value="Ingushetia">Ингушетия</option>
                            <option value="Dagestan">Дагестан</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Стоимость товара (₽)</label>
                        <input type="number" id="product-price" name="product-price" placeholder="Например, 200000" required>
                    </div>
                    <div class="form-group">
                        <label for="down-payment">Первоначальный взнос (₽)</label>
                        <input type="number" id="down-payment" name="down-payment" placeholder="Например, 70000" required>
                    </div>
                    <div class="form-group">
                        <label for="term">Срок (месяцев)</label>
                        <select id="term" name="term" required>
                            <option value="2">2 месяца</option>
                            <option value="3">3 месяца</option>
                            <option value="4">4 месяца</option>
                            <option value="5">5 месяцев</option>
                            <option value="6" selected>6 месяцев</option>
                            <option value="7">7 месяцев</option>
                            <option value="8">8 месяцев</option>
                            <option value="9">9 месяцев</option>
                            <option value="10">10 месяцев</option>
                            <option value="11">11 месяцев</option>
                            <option value="12">12 месяцев</option>
                        </select>
                    </div>
                    <button type="submit" class="calculate-btn">Рассчитать</button>
                </form>
            </section>

            <section id="results-section" class="card">
                <h2>Сравнение предложений</h2>
                <div id="results-container">
                     <div class="placeholder">
                        <p>Введите данные в калькулятор, чтобы увидеть здесь сравнение предложений.</p>
                     </div>
                </div>
            </section>
        </main>
        
        <footer>
            <p>© 2025 Vsay-rassrochka</p>
        </footer>
    </div>
    
    <div id="application-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close" aria-label="Закрыть модальное окно">&times;</button>
            
            <form id="google-form" action="https://docs.google.com/forms/d/e/1FAIpQLSetrQI4QWortTrSFRevYywlZjYJlw6Qolmfqrkt_hcZuz_6DQ/formResponse" method="POST" target="hidden_iframe">
                <div id="form-inputs">
                    <h2>Заявка на рассрочку</h2>
                    <div class="form-group">
                        <label for="modal-name">Имя</label>
                        <input type="text" id="modal-name" name="entry.403278400" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-phone">Телефон</label>
                        <input type="tel" id="modal-phone" name="entry.306095172" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-email">Электронная почта</label>
                        <input type="email" id="modal-email" name="entry.1166816010" required>
                    </div>
                    <div class="form-group">
                        <label for="product-name-input-visible">Название товара</label>
                        <input type="text" id="product-name-input-visible" name="entry.1758070087" required>
                    </div>
                    <div class="form-group">
                        <label for="product-link-input-visible">Ссылка на товар (необязательно)</label>
                        <input type="url" id="product-link-input-visible" name="entry.1720974032">
                    </div>
                    
                    <input type="hidden" id="bank-name-input" name="entry.1726191390" value="">
                    <input type="hidden" id="calc-price-input" name="entry.981090326" value="">
                    <input type="hidden" id="calc-downpayment-input" name="entry.1417851249" value="">
                    <input type="hidden" id="calc-term-input" name="entry.1511281631" value="">
                    <input type="hidden" id="res-markup-input" name="entry.926945918" value="">
                    <input type="hidden" id="res-total-input" name="entry.524351229" value="">
                    <input type="hidden" id="res-monthly-input" name="entry.63595873" value="">
                    
                    <button type="submit" class="submit-btn">Отправить заявку</button>
                </div>
            </form>
            <div id="form-success-message" class="hidden" style="text-align: center;">
                <h3>Спасибо!</h3>
                <p>Ваша заявка успешно отправлена. Мы скоро с вами свяжемся.</p>
                <p class="disclaimer" style="margin-top: 1rem;">💡 Напоминаем, сервис работает в тестовом режиме. Условия рассрочки рассчитываются ориентировочно и не являются публичной офертой</p>
            </div>
        </div>
    </div>
    
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const form = document.getElementById('calculator-form');
            const resultsContainer = document.getElementById('results-container');
            const modal = document.getElementById('application-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const googleForm = document.getElementById('google-form');
            const formInputs = document.getElementById('form-inputs');
            const formSuccessMessage = document.getElementById('form-success-message');
            
            // State variables
            let lastCalculationInputs = {};
            
            // --- Calculation Logic for Each Bank ---
            const banks = [
                {
                    name: 'Al-Baraka',
                    region: 'Ingushetia',
                    calculate: (price, downPayment, term) => {
                        const MAX_PRICE = 300000;
                        const MIN_DOWN_PAYMENT_RATE = 0.25;
                        const TERM_MARKUP_RATES = { 3: 0.06, 6: 0.12, 9: 0.181, 12: 0.242 };

                        if (price > MAX_PRICE || downPayment < (price * MIN_DOWN_PAYMENT_RATE) || !TERM_MARKUP_RATES[term]) {
                            return null;
                        }

                        const financedAmount = price - downPayment;
                        const markupValue = financedAmount * TERM_MARKUP_RATES[term];
                        const totalPayout = financedAmount + markupValue;
                        const monthlyPayment = totalPayout / term;
                        
                        return {
                            markup: markupValue,
                            totalCost: price + markupValue,
                            monthlyPayment: monthlyPayment,
                            note: `Макс. сумма 300т, мин. взнос 25%`
                        };
                    }
                },
                {
                    name: 'Tasnim',
                    region: 'Ingushetia',
                    calculate: (price, downPayment, term) => {
                        const MARKUP_RATE = 0.075;
                        const financedAmount = price - downPayment;
                        const markupValue = financedAmount * MARKUP_RATE;
                        const totalPayout = financedAmount + markupValue;
                        const monthlyPayment = totalPayout / term;
                        
                        return {
                            markup: markupValue,
                            totalCost: downPayment + totalPayout,
                            monthlyPayment: monthlyPayment
                        };
                    }
                },
                {
                    name: 'ФинЛайт',
                    region: 'Ingushetia',
                    calculate: (price, downPayment, term) => {
                        const MAX_PRICE = 300000;
                        const MAX_TERM = 9;
                        const MIN_DOWN_PAYMENT_RATE = 0.25;
                        const MARKUP_RATE = 0.125;

                        if (price > MAX_PRICE || term > MAX_TERM || downPayment < (price * MIN_DOWN_PAYMENT_RATE)) {
                            return null;
                        }

                        const financedAmount = price - downPayment;
                        const markupValue = financedAmount * MARKUP_RATE;
                        const totalPayout = financedAmount + markupValue;
                        const monthlyPayment = totalPayout / term;

                        return {
                            markup: markupValue,
                            totalCost: downPayment + totalPayout,
                            monthlyPayment: monthlyPayment,
                            note: 'Макс. сумма 300т, макс. срок 9 мес., мин. взнос 25%'
                        };
                    }
                },
                {
                    name: 'LaRiba',
                    region: 'Dagestan',
                    calculate: (price, downPayment, term) => {
                        const MARKUP_RATE = 0.15;
                        const financedAmount = price - downPayment;
                        const markupValue = financedAmount * MARKUP_RATE;
                        const totalPayout = financedAmount + markupValue;
                        const monthlyPayment = totalPayout / term;

                        return {
                            markup: markupValue,
                            totalCost: downPayment + totalPayout,
                            monthlyPayment: monthlyPayment
                        };
                    }
                },
                {
                    name: 'Vatan',
                    region: 'Dagestan',
                    calculate: (price, downPayment, term) => {
                        const TERM_MARKUP_RATES = { 3: 0.13, 6: 0.214, 9: 0.319444, 12: 0.4216 };
                        if (!TERM_MARKUP_RATES[term]) return null;

                        const financedAmount = price - downPayment;
                        const markupValue = financedAmount * TERM_MARKUP_RATES[term];
                        const totalPayout = financedAmount + markupValue;
                        const monthlyPayment = totalPayout / term;
                        
                        return {
                            markup: markupValue,
                            totalCost: downPayment + totalPayout,
                            monthlyPayment: monthlyPayment
                        };
                    }
                }
            ];

            // --- Main Event Listeners ---
            form.addEventListener('submit', (event) => {
                event.preventDefault();

                const region = document.getElementById('region').value;
                const productPrice = parseFloat(document.getElementById('product-price').value);
                const downPayment = parseFloat(document.getElementById('down-payment').value);
                const term = parseInt(document.getElementById('term').value, 10);

                if (isNaN(productPrice) || productPrice <= 0) {
                    alert('Пожалуйста, введите корректную стоимость товара.');
                    return;
                }
                if (isNaN(downPayment) || downPayment < 0) {
                    alert('Пожалуйста, введите корректный первоначальный взнос.');
                    return;
                }
                if (downPayment >= productPrice) {
                    alert('Первоначальный взнос не может быть больше или равен стоимости товара.');
                    return;
                }
                
                lastCalculationInputs = { productPrice, downPayment, term };

                const results = banks
                    .filter(bank => bank.region === region)
                    .map(bank => {
                        const calculatedData = bank.calculate(productPrice, downPayment, term);
                        return calculatedData ? { ...bank, ...calculatedData } : null;
                    })
                    .filter(Boolean); // Filter out null results
                
                displayResults(results);
                
                if (typeof ym === 'function') {
                    ym(ymCounterId, 'reachGoal', 'calculate_button_click', {
                        price: productPrice,
                        down_payment: downPayment,
                        term: term,
                        region: region
                    });
                }
            });
            
            function displayResults(results) {
                const formatCurrency = (value) => Math.round(value).toLocaleString('ru-RU');

                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="placeholder">
                            <p>Нет доступных предложений для указанных параметров. Попробуйте изменить условия.</p>
                        </div>`;
                    return;
                }
                
                const tableContent = `
                    <div class="table-wrapper">
                        <table class="results-table" aria-live="polite">
                            <thead>
                                <tr>
                                    <th scope="col">Компания</th>
                                    <th scope="col">Наценка (₽)</th>
                                    <th scope="col">Итого (₽)</th>
                                    <th scope="col">В месяц (₽)</th>
                                    <th scope="col">Действие</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.map(result => {
                                    const noteHtml = result.note ? `<span class="bank-note">${result.note}</span>` : '';
                                    return `
                                    <tr>
                                        <td data-label="Компания" class="bank-name-cell">${result.name}${noteHtml}</td>
                                        <td data-label="Наценка (₽)">${formatCurrency(result.markup)}</td>
                                        <td data-label="Итого (₽)">${formatCurrency(result.totalCost)}</td>
                                        <td data-label="В месяц (₽)">${formatCurrency(result.monthlyPayment)}</td>
                                        <td data-label="Действие">
                                            <button class="apply-btn" 
                                                    data-bank-name="${result.name}"
                                                    data-markup="${result.markup}"
                                                    data-total-cost="${result.totalCost}"
                                                    data-monthly-payment="${result.monthlyPayment}">
                                                Подать заявку
                                            </button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="disclaimer">💡 Расчёты носят справочный характер. Финальные условия уточняйте у компании-продавца.</p>
                `;
                resultsContainer.innerHTML = tableContent;
            }
            
            // --- Modal and Form Submission Logic ---
            resultsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('apply-btn')) {
                    const button = event.target;
                    const bankName = button.getAttribute('data-bank-name');
                    const resultData = {
                        markup: button.getAttribute('data-markup'),
                        totalCost: button.getAttribute('data-total-cost'),
                        monthlyPayment: button.getAttribute('data-monthly-payment'),
                    };
                    openModal(bankName, resultData);
                }
            });
            
            googleForm.addEventListener('submit', () => {
                setTimeout(() => {
                    formInputs.classList.add('hidden');
                    formSuccessMessage.classList.remove('hidden');
                }, 100);

                 if (typeof ym === 'function') {
                    ym(ymCounterId, 'reachGoal', 'application_sent', {
                        bank: document.getElementById('bank-name-input').value,
                        price: lastCalculationInputs.productPrice,
                        down_payment: lastCalculationInputs.downPayment,
                        term: lastCalculationInputs.term
                    });
                }
            });
            
            function resetModalForm() {
                formInputs.classList.remove('hidden');
                formSuccessMessage.classList.add('hidden');
                googleForm.reset();
            }

            function openModal(bankName, resultData) {
                resetModalForm();
                
                document.getElementById('bank-name-input').value = bankName;
                document.getElementById('calc-price-input').value = lastCalculationInputs.productPrice;
                document.getElementById('calc-downpayment-input').value = lastCalculationInputs.downPayment;
                document.getElementById('calc-term-input').value = lastCalculationInputs.term;
                document.getElementById('res-markup-input').value = Math.round(parseFloat(resultData.markup));
                document.getElementById('res-total-input').value = Math.round(parseFloat(resultData.totalCost));
                document.getElementById('res-monthly-input').value = Math.round(parseFloat(resultData.monthlyPayment));

                modal.classList.add('active');
                
                if (typeof ym === 'function') {
                    ym(ymCounterId, 'reachGoal', 'apply_button_click', { 
                        bank: bankName,
                        price: lastCalculationInputs.productPrice,
                        down_payment: lastCalculationInputs.downPayment,
                        term: lastCalculationInputs.term
                    });
                }
            }

            function closeModal() {
                modal.classList.remove('active');
            }

            modalCloseBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
